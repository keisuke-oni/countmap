<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<title>来場者集計マップv2 by 郵便番号</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="http://maps.google.com/maps/api/js?sensor=false&language=ja"></script>
	<style type="text/css">
		html, body {
			width: 100%;
			height: 100%;
			margin: 0;
			padding: 0;

		}
		#map {
			height: 94%;
		}
		
		#loading-view {
			/* 領域の位置やサイズに関する設定 */
			width: 100%;
			height: 100%;
			z-index: 9999;
			position: fixed;
			top: 0;
			left: 0;
			/* 背景関連の設定 */
			background-color: #000000;
			filter: alpha(opacity=85);
			-moz-opacity: 0.85;
			-khtml-opacity: 0.85;
			opacity: 0.85;
			background-image: url(./loading.gif);
			background-position: center center;
			background-repeat: no-repeat;
			background-attachment: fixed;
			color: #FFFFFF;
			font-size: x-large;
		}
	</style>
</head>
<body>
	<div id="fm">
		<strong>来場者集計マップv2 by 郵便番号</strong>
		<input type="file" id="filePicker" \>
		<button onclick="analData()" id="analData">解析開始</button>
		<button onclick="saveData()" id="saveData">保存</button>
		<button onclick="openData()" id="openData">開く</button>
		<button onclick="location.reload()">リセット</button>
	</div>
	<div id="map"></div>
	<div style="text-align: center;">Copyright(C) 2015 Keisuke Inoue (I13I006). All Rights Reserved.</div>
	<script type="text/javascript">
		function loadingView(flag) {
			$('#loading-view').remove();
			if(!flag) return;
  			$('<div id="loading-view" />').appendTo('body');
		}
		
		var data = "";
		var postArrHash = new Object();
		
		var postPop = new Object(); //人数
		var postLat = new Object(); //緯度
		var postLng = new Object(); //経度
		
		var latlng = new google.maps.LatLng(34.69619, 133.926391);
		var options = {
			zoom: 12,
			center: latlng,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		}
		var map = new google.maps.Map(document.getElementById('map'), options);
		var marker = new google.maps.Marker({
			position: latlng,
			map: map
		});
		
		function analData() {
//			alert("解析を開始しました");
//			loadingView(true);
			var file = document.getElementById("filePicker").files[0];
			var reader = new FileReader();
			reader.onload = function (event) {
				var str = event.target.result;
				str = str.replace(/\r\n/g, "\n");
				str = str.replace(/^(\n+)|(\n+)$/g, "");
				postArr = str.split(/\n/g);
				for(var i = 0; i < postArr.length; i++){
					if (postArrHash[postArr[i]]){
						postArrHash[postArr[i]] += 1;
					}else{
						postArrHash[String(postArr[i])] = parseInt(1);
					}
				}
				//次の処理はこここに書く
				loadingView(true);
				createDataPre();
			}
			reader.readAsText(file, "utf-8");
		}
		
		var judge = 0;
		var judge2 = 0;
		var count = 0;
		
		function createDataPre(){
			for (var key in postArrHash){
				count++;
			}
			setTimeout(function(){
				for (var key in postArrHash) {
					createData(key);
//					console.log(count);
				}
			}, 1500);
		}
		
		function createData(postNum) {
//			console.log("Running!!");
			var geocoder = new google.maps.Geocoder();
			geocoder.geocode({
				'address': postNum
			}, function(result, status) {
				if (status == google.maps.GeocoderStatus.OK){
					data += postNum + "," + postArrHash[postNum] + "," + result[0].geometry.location.lat() + "," + result[0].geometry.location.lng() + "\n";
					judge += 1;
//					console.log(judge);
					document.getElementById('loading-view').innerHTML = count + "件中" + (judge + judge2) + "件処理しました。";
				if(judge + judge2 === count){
						loadingView(false);
						alert("解析終了！");
						createObject();
				}
				}else{
					if (status == "OVER_QUERY_LIMIT"){
						setTimeout(function(){
							createData(postNum);
						}, 100);
					}else{
						console.log(status + " " + postNum);
						judge2 += 1;
						console.log(judge2);
					}
				}
			});
		}
		
		function saveData() {
			var blob = new Blob([data], {type: "text/csv"});
			
			if(window.navigator.msSaveBlob){
				window.navigator.msSaveBlob(blob, "save_data.csv");
			}else{
				var a = document.createElement("a");
				a.href = URL.createObjectURL(blob);
				a.target = '_blank';
				a.download = 'save_data.csv';
				a.click();
			}
		}
		
		function openData() {
			var file = document.getElementById("filePicker").files[0];
			var reader = new FileReader();
			reader.onload = function (event) {
				data = event.target.result;
			createObject();
			}
			reader.readAsText(file, "utf-8");
		}
		
		function createObject() {
			console.log("createObjectRunning");
			data = data.replace(/\r\n/g, "\n");
			data = data.replace(/^(\n+)|(\n+)$/g, "");
			infoArr = data.split(/\n/g);
//			console.log(infoArr);
			
			for (var i = 0; i < infoArr.length; i++){
				infoArr2 = infoArr[i].split(/,/g);
				postPop[infoArr2[0]] = infoArr2[1];
				postLat[infoArr2[0]] = infoArr2[2];
				postLng[infoArr2[0]] = infoArr2[3];	
//				console.log(infoArr2);
				markCircle(infoArr2[0]);
			}
		}
		
		function markCircle(postNum){
			var clatlng = new google.maps.LatLng(postLat[postNum], postLng[postNum]);
			var popCircle = new google.maps.Circle({
				strokeColor: "#FF0000",
				strokeOpacity: 0.8,
				strokeWeight: 2,
				fillColor: "#FF0000",
				fillOpacity: 0.35,
				map: map,
				center: clatlng,
				radius: postPop[postNum] * 30
			});
			var infoWindow = new google.maps.InfoWindow();
			google.maps.event.addListener(popCircle, 'click', function(){
				infoWindow.setPosition(clatlng);
				infoWindow.setContent("〒" + postNum + "<br />来場者："+ postPop[postNum]+"人");
				infoWindow.open(map);
			});
		}
	</script>
</body>
</html>